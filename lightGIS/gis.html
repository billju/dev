<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS</title>
    <link rel="stylesheet" href="css/bootstrap.css">
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="position-fixed" style="right:0;top:0;">
        <table>
            <tr id="raster" draggable="true" ondragstart="dragged=event.target" ondrop="handleDrop(event,this)" ondragover="event.preventDefault()">
                <td class="pb-1 pr-1">
                    <span>{{name}}</span>
                </td>
                <td class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="customSwitch">
                    <label class="custom-control-label" for="customSwitch"></label>
                </td>
                <td class="input-text" draggable="true" ondragstart="event.preventDefault();event.stopPropagation()">
                    <input type="range" class="custom-range" min="0" max="1" step="0.1" value="0.8" style="direction: rtl;">
                </td>
            </tr>
        </table>
        <input type="file" id="file" style="display: none;"
            onchange="handleFile(event.target.files[0])">
        <div id="drop-field" ondrop="handleDrop(event)" ondragover="event.preventDefault()"
            onclick="document.getElementById('file').click()">加入檔案</div>
    </div>
    <table id="properties" class="table table-striped table-hover table-dark" style="max-width:300px;max-height:100vh;position:fixed;left:0;top:0"></table>
    <table id="styles" class="table table-striped table-hover table-dark"
        style="max-width:200px;position:fixed;left:0;bottom:0;margin-bottom:0;cursor:move;display:none">
        <tr>
            <td colspan="2">
                <div class="btn-group w-100">
                    <div class="btn btn-dark" onclick="interaction.fitExtent()">聚焦</div>
                    <div class="btn btn-dark" onclick="interaction.moveLayerTo('top')">置頂</div>
                    <div class="btn btn-dark" onclick="interaction.moveLayerTo('bottom')">置底</div>
                </div>
            </td>
        </tr>
        <tr>
            <td>radius</td>
            <td><input type="number" style="width:50px;" min="1" oninput="interaction.setFeatureProps('radius',event.target.value)"></td>
        </tr>
        <tr>
            <td>lineWidth</td>
            <td><input type="number" style="width:50px;" min="0" oninput="interaction.setFeatureProps('lineWidth',event.target.value)"></td>
        </tr>
        <tr>
            <td>stroke</td>
            <td><input type="color" oninput="interaction.setFeatureProps('stroke',event.target.value)"></td>
        </tr>
        <tr>
            <td>fill</td>
            <td><input type="color" oninput="interaction.setFeatureProps('fill',event.target.value)"></td>
        </tr>
    </table>
</body>
<style>
    *{
        font-family: 微軟正黑體;
    }
    html, body{
        margin: 0;
        height: 100%;
    }
    #canvas{
        width: 100%;
        height: 100%;
    }
    #drop-field{
        width: 100%;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        background: dodgerblue;
    }
    td span{
        color: #fff;
        text-shadow: 1px 1px 2px black;
    }
</style>
<script src="js/GisMap.js"></script>
<script src="js/ImageShape.js"></script>
<script src="js/interaction.js"></script>
<script src="js/ptx.js"></script>
<script src="js/makeElementMovable.js"></script>
<script>
    makeElementMovable(document.getElementById('styles'))
    var canvas = document.getElementById('canvas')
    var ctx = canvas.getContext('2d')
    var gm = new GisMap(canvas)
    var interaction = new Interaction(gm)
    function handleDrop(e){
        e.preventDefault()
        const files = [...e.dataTransfer.items].filter(item=>item.kind=='file').map(item=>item.getAsFile())
        handleFile(files[0])
    }
    function handleFile(file){
        if(file.type.includes('image')){
            let img = new Image()
            img.src = URL.createObjectURL(file)
            img.onload = ()=>{
                let imageShape = new ImageShape(img,canvas.width/2,canvas.height/2,gm)
                interaction.imageShapes.unshift(imageShape)
            }
        }
        if(file.name.split('.')[1]=='geojson'){
            let reader = new FileReader()
            reader.onload = ()=>{
                let geojson = JSON.parse(reader.result)
                let layer = file.name.split('.')[0]
                geojson.features.map(f=>{f.properties['圖層']=f.properties['圖層']||layer})
                gm.geojson(geojson)
            }
            reader.readAsText(file)
        }
        if(file.name.split('.')[1]=='wkt'){
            let reader = new FileReader()
            reader.onload = ()=>{
                gm.WKT(reader.result)
            }
            reader.readAsText(file)
        }
        if(file.name.split('.')[1]=='json'){
            let reader = new FileReader()
            reader.onload = ()=>{
                const dir = {0:'去程',1:'返程',2:'迴圈',255:'未知'}
                JSON.parse(reader.result).map(row=>{
                    gm.WKT(row.Geometry,{'路線':row.RouteName.Zh_tw,'方向':dir[row.Direction]})
                })
            }
            reader.readAsText(file)
        }
    }
</script>
</html>