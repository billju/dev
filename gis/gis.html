<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS</title>
    <link rel="stylesheet" href="../css/bootstrap.css">
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="position-fixed" style="right:0;top:0;">
        <table>
            <tr id="raster" draggable="true" ondragstart="dragged=event.target" ondrop="handleDrop(event,this)" ondragover="event.preventDefault()">
                <td class="pb-1 pr-1">
                    <span>{{name}}</span>
                </td>
                <td class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="customSwitch">
                    <label class="custom-control-label" for="customSwitch"></label>
                </td>
                <td class="input-text" draggable="true" ondragstart="event.preventDefault();event.stopPropagation()">
                    <input type="range" class="custom-range" min="0" max="1" step="0.1" value="0.8" style="direction: rtl;">
                </td>
            </tr>
        </table>
        <table id="properties" class="table table-striped table-hover table-dark" style="max-width:300px;max-height:100vh;position:fixed;left:0;top:0"></table>
        <input type="file" id="file" style="display: none;"
            onchange="handleFile(event.target.files[0])">
        <div id="drop-field" ondrop="handleDrop(event)" ondragover="event.preventDefault()"
            onclick="document.getElementById('file').click()">加入檔案</div>
    </div>
</body>
<style>
    *{
        font-family: 微軟正黑體;
    }
    html, body{
        margin: 0;
        height: 100%;
    }
    #canvas{
        width: 100%;
        height: 100%;
    }
    #drop-field{
        width: 100%;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        background: dodgerblue;
    }
    td span{
        padding: 0 5px;
        border-radius: 20px;
        background: #fff;
    }
</style>
<script src="GisMap.js"></script>
<script src="ImageShape.js"></script>
<script>
    var canvas = document.getElementById('canvas')
    var ctx = canvas.getContext('2d')
    var gm = new GisMap(canvas)
    // gm.geojson({features:[{properties:{bang:'gang'},geometry:{type:'LineString',coordinates:[[121,24],[122,25]]}}]})
    var imageShapes = []
    const propsTable = document.getElementById('properties')
    canvas.addEventListener('render',e=>{
        for(let imageShape of imageShapes){
            imageShape.updateGisClient()
            imageShape.draw(ctx)
        }
    })
    canvas.addEventListener('mousedown',e=>{
        let noImageShapeSelected = true
        for(let imageShape of imageShapes){
            if(imageShape.handleMousedown(e)){
                imageShape.editing = true
                noImageShapeSelected = false
            }else{
                imageShape.editing = false
            }
        }
        if(noImageShapeSelected)
            gm.handleMousedown(e)
    })
    canvas.addEventListener('mousemove',e=>{
        for(let imageShape of imageShapes){
            if(imageShape.editing){
                imageShape.handleMousemove(e)
            }
        }
        gm.handleMousemove(e)
    })
    canvas.addEventListener('mouseup',e=>{
        for(let imageShape of imageShapes)
            imageShape.handleMouseup(e)
        let feature = gm.detectClient(e)
        if(feature){
            propsTable.innerHTML = ''
            Object.entries(feature.properties).map(([key,val])=>{
                if(val&&val!='null'){
                    let tr = propsTable.insertRow()
                    tr.insertCell().textContent = key
                    tr.insertCell().textContent = val
                }
            })
        }else if(!gm.moveEvent.moved){
            propsTable.innerHTML = ''
            gm.selectedFeature = null
        }
        gm.handleMouseup(e)
    })
    canvas.addEventListener('mouseleave',e=>{
        for(let imageShape of imageShapes)
            imageShape.handleMouseup(e)
        gm.handleMouseup(e)
    })
    window.addEventListener('keydown',e=>{
        for(let imageShape of imageShapes)
            imageShape.handleKeydown(e)
    })
    window.addEventListener('keyup',e=>{
        for(let imageShape of imageShapes)
            imageShape.handleKeyup(e)
        if(e.code=='Delete'){
            imageShapes = imageShapes.filter(x=>!x.editing)
        }
    })
    canvas.addEventListener('wheel',e=>{
        gm.handleWheel(e)
    })
    window.addEventListener('resize',()=>{
        gm.handleResize()
    })
    let rasterElement = document.getElementById('raster')
    let rasters = [
        {url:'https://lohas.taichung.gov.tw/arcgis/rest/services/Tiled3857/URBAN3857/MapServer/tile/{z}/{y}/{x}?blankTile=false&token={token}',name:'臺中都市計畫',opacity:0.8,active:false},
        {url:'https://lohas.taichung.gov.tw/arcgis/rest/services/Tiled3857/Land3857/MapServer/tile/{z}/{y}/{x}?blankTile=false&token={token}',name:'地段及地籍圖',opacity:0.8,active:false},
        {url:'https://lohas.taichung.gov.tw/arcgis/rest/services/Tiled3857/LandPriceMapAA163857/MapServer/tile/{z}/{y}/{x}?blankTile=false&token={token}',name:'公告現值',opacity:0.8,active:false},
        {url:'https://lohas.taichung.gov.tw/arcgis/rest/services/Tiled3857/LandPriceMapAA173857/MapServer/tile/{z}/{y}/{x}?blankTile=false&token={token}',name:'公告地價',opacity:0.8,active:false},
        {url:'https://eghouse.hccg.gov.tw/arcgis/rest/services/Tiled3857/Nature_policy/MapServer/tile/{z}/{y}/{x}?blankTile=false',name:'特殊管制',opacity:0.8,active:false},
        {url:'https://eghouse.hccg.gov.tw/arcgis/rest/services/Tiled3857/Nature_water/MapServer/tile/{z}/{y}/{x}?blankTile=false',name:'水源水質',opacity:0.8,active:false},
        {url:'https://eghouse.hccg.gov.tw/arcgis/rest/services/Tiled3857/Nature_geo/MapServer/tile/{z}/{y}/{x}?blankTile=false',name:'地質敏感',opacity:0.8,active:false},
        {url:'https://eghouse.hccg.gov.tw/arcgis/rest/services/Tiled3857/Nature_environment/MapServer/tile/{z}/{y}/{x}?blankTile=false',name:'環保與汙染',opacity:0.8,active:false},
        {url:'https://eghouse.hccg.gov.tw/arcgis/rest/services/Tiled3857/SlopeTW3857_fix/MapServer/tile/{z}/{y}/{x}?blankTile=false',name:'坡度示意圖',opacity:0.8,active:false},
        {url:'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',name:'OSM',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}',name:'通用',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/EMAP01/default/EPSG:3857/{z}/{y}/{x}',name:'灰階',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/PHOTO2/default/EPSG:3857/{z}/{y}/{x}',name:'航照',opacity:0.8,active:false},
        {url:'https://mts1.google.com/vt/lyrs=s@186112443&hl=x-local&src=app&x={x}&y={y}&z={z}&s=Galile',name:'Google衛星',opacity:0.8,active:false},
        {url:'https://mts1.google.com/vt/lyrs=p@186112443&hl=x-local&src=app&x={x}&y={y}&z={z}&s=Galile',name:'Google地形',opacity:0.8,active:false},
        {url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',name:'ESRI衛星',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/EMAPX99/default/EPSG:3857/{z}/{y}/{x}',name:'交通路網',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/EPSG:3857/{z}/{y}/{x}',name:'國土利用',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/EPSG:3857/{z}/{y}/{x}',name:'公有土地',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/SCHOOL/default/EPSG:3857/{z}/{y}/{x}',name:'學校',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/Village/default/EPSG:3857/{z}/{y}/{x}',name:'村里界',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/TOWN/default/EPSG:3857/{z}/{y}/{x}',name:'鄉市鎮界',opacity:0.8,active:false},
        {url:'https://wmts.nlsc.gov.tw/wmts/CITY/default/EPSG:3857/{z}/{y}/{x}',name:'縣市界',opacity:0.8,active:false},
    ]
    const token = "qn5cMMfaz2E84GbcNlqB2deRwJpO0NfuIorLEzgqLiaQv3lB8mfoVF7VU0u0rJCMbkMjDCBz2xD1JH-8fYMuBg.."
    for(let i=0;i<4;i++){
        rasters[i].url = rasters[i].url.replace('{token}',token)
    }
    gm.raster = rasters
    for(let raster of rasters){
        let rE = rasterElement.cloneNode(true)
        let checkbox = rE.querySelector('input[type="checkbox"]')
        checkbox.id = raster.name
        checkbox.onchange = e=>{
            let idx = gm.raster.findIndex(x=>x.name==raster.name)
            gm.raster[idx].active = e.target.checked
        }
        if(raster.name=='通用'){
            setTimeout(()=>{
                checkbox.checked=true
            },2000)
            setTimeout(()=>{
                raster.active = true
            },3000)
        }
        rE.querySelector('label').setAttribute('for',raster.name)
        let range = rE.querySelector('input[type="range"')
        range.oninput = e=>{
            let idx = gm.raster.findIndex(x=>x.name==raster.name)
            gm.raster[idx].opacity = e.target.value*1.0
        }
        rE.querySelector('span').textContent = raster.name
        rasterElement.parentNode.appendChild(rE)
    }
    rasterElement.remove()
    function handleDrop(e){
        e.preventDefault()
        const files = [...e.dataTransfer.items].filter(item=>item.kind=='file').map(item=>item.getAsFile())
        handleFile(files[0])
    }
    function handleFile(file){
        if(file.type.includes('image')){
            let img = new Image()
            img.src = URL.createObjectURL(file)
            img.onload = ()=>{
                let imageShape = new ImageShape(img,canvas.width/2,canvas.height/2,gm)
                imageShapes.push(imageShape)
            }
        }
        if(file.name.split('.')[1]=='geojson'){
            let reader = new FileReader()
            reader.onload = ()=>{
                let geojson = JSON.parse(reader.result)
                gm.geojson(geojson)
            }
            reader.readAsText(file)
        }
        if(file.name.split('.')[1]=='wkt'){
            let reader = new FileReader()
            reader.onload = ()=>{
                gm.WKT(reader.result)
            }
            reader.readAsText(file)
        }
        if(file.name.split('.')[1]=='json'){
            let reader = new FileReader()
            reader.onload = ()=>{
                const dir = {0:'去程',1:'返程',2:'迴圈',255:'未知'}
                JSON.parse(reader.result).map(row=>{
                    gm.WKT(row.Geometry,{'路線':row.RouteName.Zh_tw,'方向':dir[row.Direction]})
                })
            }
            reader.readAsText(file)
        }
    }
    var dragged
    function handleDrop(e,element){
        e.preventDefault()
        let srcIdx = [...element.parentNode.children].findIndex(x=>x==dragged)
        let src = rasters[srcIdx]
        rasters.splice(srcIdx,1)
        let tarIdx = [...element.parentNode.children].findIndex(x=>x==element)
        rasters.splice(tarIdx,0,src)
        console.log(srcIdx+'->'+tarIdx)
        if(srcIdx>tarIdx){
            element.parentNode.insertBefore(dragged,element)
        }else{
            element.parentNode.insertBefore(dragged,element.nextSibling)
        }
    }
    function getPTX(){
        fetch('https://ptx.transportdata.tw/MOTC/v2/Bike/Station/Taichung?$select=StationName%2CStationPosition%2CBikesCapacity&$format=JSON')
        .then(res=>res.json()).then(json=>{
            for(let row of json){
                gm.addVector('Point',[row.StationPosition.PositionLon,row.StationPosition.PositionLat],{
                    "車站": row.StationName.Zh_tw,
                    "容量": row.BikesCapacity,
                    "經度": row.StationPosition.PositionLon,
                    "緯度": row.StationPosition.PositionLat,
                    radius: row.BikesCapacity/10,
                })
            }
        })
    }
</script>
</html>