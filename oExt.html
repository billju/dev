<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oTranscribe Ext</title>
</head>
<body>
    <audio></audio>
    <input type="file">
    <div id="overview"></div>
    <div id="zoomview"></div>
</body>
<style>
    html,body{
        margin: 0;
    }
</style>
<script>
var audio = document.querySelector('audio')
var canvas = document.createElement('canvas')
var ctx = canvas.getContext('2d')
canvas.width = canvas.style.width = window.innerWidth
canvas.height = canvas.style.height = 50
canvas.style.position = 'fixed'
canvas.style.left = 0
canvas.style.top = '50px'
document.body.appendChild(canvas)
function getPeaks(width, data){
    const step = Math.floor(data.length/width)
    var peaks = new Array(width)
    var minPeak = 0, maxPeak = 0
    for(let i=0;i<width;i++){
        let batch = data.slice(i*step,(i+1)*step)
        let min = Math.min(...batch)
        let max = Math.max(...batch)
        minPeak = Math.min(min, minPeak)
        maxPeak = Math.max(max, maxPeak)
        peaks[i] = [min,max]
    }
    return peaks
}
function drawPeaks(peaks,offset){
    var amp = cy = canvas.height/2
    ctx.beginPath()
    ctx.moveTo(offset,canvas.height/2)
    peaks.map((peak,i)=>{
        ctx.lineTo(i+offset,peak[0]*amp+cy)
        ctx.lineTo(i+offset,peak[1]*amp+cy)
    })
    ctx.strokeStyle = 'black'
    ctx.lineWidth = 1
    ctx.stroke()
    ctx.closePath()
}
document.querySelector('input[type="file"]').onchange = e=>{
    const file = e.target.files[0]
    const reader = new FileReader()
    reader.readAsDataURL(file)
    reader.onload = async()=>{
        if(file.type=='audio/mp3'){
            audio.src = reader.result
            const aCtx = new AudioContext()
            const mediaSource = aCtx.createMediaElementSource(audio)
            const analyser = aCtx.createAnalyser()
            mediaSource.connect(analyser)
            analyser.connect(aCtx.destination)
            const data = new Uint8Array(analyser.frequencyBinCount);
            audio.ontimeupdate = ()=>{
                analyser.getByteTimeDomainData(data)
                let imgData = ctx.getImageData(1, 0, canvas.width - 1, canvas.height);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.putImageData(imgData, 0, 0);
                let H = Math.max(...data)/256*canvas.height
                ctx.fillRect(canvas.width-1,(canvas.height-H)/2,1,H)
            }
            audio.play()

            // var steps = canvas.width
            // var stepLen = Math.floor(arrayBuffer.byteLength/steps)
            // var stepWidth = Math.floor(canvas.width/steps)
            // for(let i=0;i<steps;i++){
            //     let batch = arrayBuffer.slice(i*stepLen,(i+1)*stepLen)
            //     try{
            //         let audioBuffer = await aCtx.decodeAudioData(batch)
            //         let peaks = getPeaks(stepWidth, audioBuffer.getChannelData(0))
            //         drawPeaks(peaks,i*stepWidth)
            //     }catch{}
            // }
        }
    }
}

window.onkeydown = e=>{
    if(e.code=='AltLeft'){e.preventDefault();audio.currentTime-=5}
    if(e.code=='AltRight'){e.preventDefault();audio.currentTime+=5}
}
window.onresize = ()=>{
    canvas.width = canvas.style.width = window.innerWidth
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function spectrogram(){
    var audioContext = new (window.AudioContext || window.webkitAudioContext)()
    var mediaSource = audioContext.createMediaElementSource(audio)
    var analyser = audioContext.createAnalyser()
    mediaSource.connect(analyser)
    analyser.connect(audioContext.destination)
    const data = new Uint8Array(analyser.frequencyBinCount);
    const h = canvas.height / data.length;
    ctx.fillStyle = 'hsl(280, 100%, 10%)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    loop();
    function loop() {
        window.requestAnimationFrame(loop);
        let imgData = ctx.getImageData(1, 0, canvas.width - 1, canvas.height);
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(imgData, 0, 0);
        analyser.getByteFrequencyData(data);
        for (let i = 0; i < data.length; i++) {
            let rat = data[i] / 255;
            let hue = Math.round((rat * 120) + 280 % 360);
            let sat = '100%';
            let lit = 10 + (70 * rat) + '%';
            ctx.beginPath();
            ctx.strokeStyle = `hsl(${hue}, ${sat}, ${lit})`;
            ctx.moveTo(canvas.width, canvas.height - (i * h));
            ctx.lineTo(canvas.width, canvas.height - (i * h + h));
            ctx.stroke();
        }
    }
}
</script>
</html>
