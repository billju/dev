<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTX</title>
    <link rel="stylesheet" href="../css/fontawesome.css">
    <link rel="stylesheet" href="../css/bootstrap.css">
</head>
<body>
    <div class="form-group">
        <label for="request-url">網址</label>
        <textarea id="request-url" class="form-control"></textarea>
    </div>
    <button class="btn btn-primary" onclick="handleRequest()">send</button>
    <div id="treeview"></div>
    <div class="row">
        <ul id="go" class="list-group col-6">
            <li id="template" class="list-group-item d-flex justify-content-between align-items-center">
                <span class="badge badge-primary badge-pill text-center" style="font-size: 16px;width:60px">{{time}}</span>
                <span class="px-2" style="flex:1">{{stop}}</span>
                <span class="badge badge-primary">{{plate}}</span>
            </li>
        </ul>
        <ul id="back" class="list-group col-6">
        </ul>
    </div>
</body>
<style>
*{
    font-family: 微軟正黑體;
}
html,body{
    margin:0;
}
i{
    width: 30px;
    text-align: center;
    cursor: pointer;
    user-select: none;
}
.d-flex{
    display: flex;
    align-items: center;
}
.tree-content:hover{
    background: #eee;
}
</style>
<script>
    var route = 9
    var reqURL = `https://ptx.transportdata.tw/MOTC/v2/Bus/EstimatedTimeOfArrival/City/Taichung/${route}?$select=PlateNumb,StopName,EstimateTime&$filter=NextBusTime ne null and RouteID eq '${route}'&$orderby=Direction,StopSequence&$format=JSON`
    document.getElementById('request-url').value = reqURL
    function handleRequest(){
        let url = document.getElementById('request-url').value
        let template = document.getElementById('template')
        fetch(url,{}).then(res=>res.json()).then(json=>{
            let go = document.getElementById('go')
            let back = document.getElementById('back')
            console.log(json)
            json.map(row=>{
                let li = template.cloneNode(true)
                let date = new Date(row.NextBusTime)
                let formateTime = ('0'+date.getHours()).substr(-2)+':'+('0'+date.getMinutes()).substr(-2)
                let formateEst = row.EstimateTime>60?Math.floor(row.EstimateTime/60):row.EstimateTime
                let state = {
                    time: row.EstimateTime?formateEst+'分':formateTime,
                    stop: row.StopName.Zh_tw,
                    plate: row.PlateNumb
                }
                for(let child of li.children){
                    for(let key in state){
                        child.textContent = child.textContent.replace(`{{${key}}}`,state[key])
                    }
                }
                if(row.Direction==0){
                    go.appendChild(li)
                }else{
                    back.appendChild(li)
                }
            })
            template.remove()
        })
    }
    
    class Treeview{
        constructor(parent){
            this.level = parent.level==undefined?0:parent.level+1
            this.parent = parent
            if(parent.mask){
                this.mask = parent.childMask
            }else{ // if parent is root
                this.mask = document.createElement('div')
                this.mask.className = 'tree-mask'
                this.mask.style.overflow = 'hidden'
                this.mask.style.transition = '0.3s'
                parent.appendChild(this.mask)
                this.parent.childMask = this.mask
            }
            this.content = this.createContent()
            this.mask.appendChild(this.content)
            // this.content.style.height = this.content.clientHeight+'px'
            this.childMask = document.createElement('div')
            this.childMask.className = 'tree-mask'
            this.childMask.style.overflow = 'hidden'
            this.childMask.style.transition = 'height 0.3s'
            this.childMask.style.height = 0
            this.mask.appendChild(this.childMask)
            this.children = []
            this.expanded = true
        }
        createContent(){
            var div = document.createElement('div')
            div.className = 'tree-content'
            this.caret = document.createElement('i')
            this.caret.className = 'fas fa-caret-down'
            this.caret.style.opacity = 0
            this.caret.style.transition = 'transform 0.3s'
            this.span = document.createElement('span')
            this.checkbox = document.createElement('input')
            this.checkbox.type = 'checkbox'
            div.appendChild(this.caret)
            div.appendChild(this.checkbox)
            div.appendChild(this.span)
            this.caret.onclick = e=>{
                e.stopPropagation()
                this.toggle()
            }
            div.oncontextmenu = e=>{
                e.preventDefault()
                this.appendChild()
            }
            div.style.paddingLeft = 30*this.level+'px'
            return div
        }
        appendChild(content){
            this.caret.style.opacity = '1'
            let newTreeview = new Treeview(this)
            newTreeview.span.textContent = content
            this.children.push(newTreeview)
            let diff = newTreeview.content.clientHeight
            newTreeview.syncParentHeight(diff)
            return newTreeview
        }
        remove(){
            if(this.parent.childMask)
                this.parent.children = this.parent.children.filter(x=>x!=this)
            this.mask.remove()
        }
        toggle(){
            if(this.childMask){
                this.expanded = !this.expanded
                if(this.expanded){
                    this.expand()
                }else{
                    this.collapse()
                }
            }
        }
        syncParentHeight(diff){
            let parent = this
            while(parent.mask){
                parent.mask.style.height = parent.mask.clientHeight+diff+'px'
                parent = parent.parent
            }
        }
        expand(){
            var diff = this.children.reduce((acc,cur)=>acc+cur.content.clientHeight+cur.childMask.clientHeight,0)
            this.childMask.style.height = diff+'px'
            this.syncParentHeight(diff)
            this.content.querySelector('i').style.transform = 'rotate(0)'
        }
        collapse(){
            var diff = -this.childMask.clientHeight
            this.syncParentHeight(diff)
            this.childMask.style.height = 0
            this.content.querySelector('i').style.transform = 'rotate(-90deg)'
        }
        flatten(){
            var result = [this]
            for(let child of this.children){
                result = result.concat(child.flatten())
            }
            return result
        }
    }
    // var root = new Treeview(document.getElementById('treeview'))
    // root.appendChild()//.appendChild().appendChild()
</script>
</html>